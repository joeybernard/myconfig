var SiteDialog=function(t){DialogWithGroupInput.call(this,t,{confirmOnClose:!1,hideButtons:!0,hideHeader:!0,type:Account,additionalClasses:"lmiDialog",additionalDropdownClasses:"lmiDropdown"}),this.tiles=[],this.activeTile=null,this.selectedTile=null,this.isSelectable=!1,this.submitted=!1};SiteDialog.prototype=Object.create(DialogWithGroupInput.prototype),SiteDialog.prototype.constructor=SiteDialog,function(){var t=function(t,e,i){var a=$.extend(null,t.data,{action:i,saveSiteEvent:e});bg.LPModule.callService("Segment","sendTypedEvent",["SaveSiteDialog",a],function(t){t&&console.error(t)})};SiteDialog.prototype.initialize=function(e){var i;DialogWithGroupInput.prototype.initialize.apply(this,arguments),i=this,e.on("click",".neverSave",function(){i.data.generatedPasswordSaved&&i.deleteItem(),bg.handleNeverURL({action:"never",cmd:"neverdomain",url:i.data.defaultData.url,fromsave:!0}),t(i,"SaveSiteDialogAction","Never"),bg.IntroTutorial.getState(function(t){for(var e=!1,a=0;a<t.domains.length;a++)i.data.defaultData.url.includes(t.domains[a])&&(e=!0);t.enabled&&e?bg.IntroTutorial.completeTutorial({textChoice:"skipped"}):bg.IntroTutorial.resetState(),i.close()})}),e.on("input change",function(){i.data.generatedPasswordSaved&&(i.nextButton.text(Strings.translateString("Update")),i.data.inputChanged=!0),bg.Policies.getAccountSelectionBasedOnEmail(function(t){t&&bg.getLinkedAccount(function(t){var a=i.getData();t&&a.unencryptedUsername===bg.get("g_username")&&-1!==a.group.indexOf(t.group)?e.find("#submit").attr("disabled","disabled"):e.find("#submit").removeAttr("disabled")})})}),i.backButton=e.find("#close").bind("click",function(){i.data.generatedPassword?i.data.generatedPasswordSaved?(i.data.matchingSites&&0===i.data.matchingSites.length?i.$element.find("#undo").text(Strings.translateString("Yes, remove")):i.$element.find("#undo").text(Strings.translateString("Yes, undo")),i.dialogContent.css({height:i.dialogContent.css("height")}),i.$element.addClass("removeGeneratedConfirmation")):(t(i,"SaveSiteDialogAction","NotNow"),i.close()):(t(i,"SaveSiteDialogAction","NotNow"),bg.IntroTutorial.getState(function(t){for(var e=!1,a=0;a<t.domains.length;a++)i.data.defaultData.url.includes(t.domains[a])&&(e=!0);t.enabled&&e?bg.IntroTutorial.completeTutorial({textChoice:"skipped"}):bg.IntroTutorial.resetState(),i.close()}))}),i.nextButton=e.find("#submit").bind("click",function(){i.isSelectable?i.selectedTile&&i.submit():i.submit()}),e.find("#closeConfirmation").bind("click",function(){t(i,"SaveSiteDialogAction","OK"),i.close()}),e.find("#undo").bind("click",function(){t(i,"SaveSiteDialogAction","Undo"),i.data.matchingSites&&0===i.data.matchingSites.length?i.deleteItem(function(){i.close()}):i.revertPasswordChange(function(){i.close()})}),e.find(".addNewSiteButton").bind("click",function(){t(i,"SaveSiteDialogNewClicked");var e=i.tiles.slice();i.defaultFields(i.data),i.originalData=i.getData(),i.populateFields(i.data.dialogData);var a=i.setupAdd();i.setSelectable(!1),$(this).LP_hide();for(var n=0;n<e.length;++n)e[n].remove();a.showDetails({animate:!1,clearErrors:!0,tileHeight:"auto"})}),e.find(".updateAnotherSiteButton").bind("click",function(){t(i,"SaveSiteDialogAnotherClicked");var e=i.tiles.slice();$(this).LP_hide();for(var a=0;a<e.length;++a)e[a].remove();i.setupUpdateAnother()})};var e=function(t){for(var e={},i=t.find("[dialogFieldDisplay]"),a=0;a<i.length;++a){var n;e[i[a].getAttribute("dialogFieldDisplay")]=!0}return e},i=function(t,e){for(var i=t.find("[dialogFieldDisplay]"),a=0;a<i.length;++a){var n=i[a],o=e[n.getAttribute("dialogFieldDisplay")];o&&(n.textContent=o)}};SiteDialog.prototype.deleteItem=function(t){this.vaultItem.deleteItem({confirm:!1,success:t})},SiteDialog.prototype.revertPasswordChange=function(t){this.vaultItem.revertPasswordChange({confirm:!1,success:t})},SiteDialog.prototype.setupAdd=function(t){t=t||this.data,this.$element.find(".question").text(Strings.translateString("Add to LastPass?")),this.nextButton.text(Strings.translateString("Add")),this.$element.find(".updateAnotherSiteButton").LP_hide();var e=new this.SiteTile;return t.defaultData.unencryptedUsername||e.showDetails({animate:!1,clearErrors:!0,tileHeight:"auto"}),e},SiteDialog.prototype.setupUpdateAnother=function(t){var e;t=t||this.data,this.$element.find(".question").text(Strings.translateString("Which account should we update?")),this.nextButton.text(Strings.translateString("Update")),this.$element.find(".addNewSiteButton").LP_hide();for(var i=0;i<t.defaultData.domainSites.length;++i)(e=new this.SiteTile({site:LPProxy.getSiteModel(t.defaultData.domainSites[i])})).setSelectable(!0);this.hasDuplicates()&&this.$element.find(".explanation").text(Strings.translateString("Choose one to update and delete the duplicate.")),this.setFrameSize()};var a=function(t,e,i){var a=$.extend({},t.defaultData);return e&&$.extend(a,e.getFormData($.extend(i,DialogInput.getProperties(t.dialogData),DialogInput.getProperties(t.defaultData)))),a},n=function(t,e,i){return $.extend(a(t,e,i),t.dialogData)},o=function(t,e){bg.LPIcons.get({url:t.defaultData.url,square:!0,callback:function(i){if(i)e(i);else{var a=function(){bg.LPPlatform.getFavicon({url:t.defaultData.url,callback:e})};t.sameDomain?csTop.LPContentScriptTools.getFavicon(function(t){t?e(t):a()}):a()}}})};SiteDialog.prototype.hasDuplicates=function(){if(!this.data.defaultData.unencryptedUsername)return!1;for(var t=0;t<this.tiles.length;++t)if(this.tiles[t].getDuplicates().length>0)return!0;return!1},SiteDialog.prototype.setup=function(o,l){l.saveOptions={source:"saveSite"},o.find(".addSiteFavicon").append(LPTools.createElement("img",{class:"favicon",src:l.favicon?l.favicon:"images/site/world.png"}));var s=this,r=o.find(".tileContainer"),d=o.find(".question"),c=o.find(".explanation"),u=o.find(".dialogForm"),g=o.find(".tile.template"),h=o.find(".deleteOverlayContainer.template"),p=e(g),f=DialogInput.getProperties(s.inputFields);this.csFeatures=bg.get("LPContentScriptFeatures");var m=this.SiteTile=function(e){e=e||{};var o=this,l=g.clone().removeClass("template"),d=null,c=s.data,m=!1,S=!1,v=null,D=!1,b=a(c,e.site,f),y=n(c,e.site,f),C=null,w=function(t){t&&s.clearErrors(),s.originalData=b,s.populateFields(y)},P,x;this.showedPassword=function(){return D},this.getDialogData=function(){return y},this.getOriginalData=function(){return b},this.getOriginalDialogData=function(){return n(c,e.site,f)},this.getDuplicates=function(){if(null===C&&(C=[],c.defaultData.unencryptedUsername)){var t=bg.hostof(y.url),e=o.getDialogData().unencryptedUsername;s.tiles.forEach(function(i){var a=i.getDialogData();i!==o&&bg.hostof(a.url)===t&&a.unencryptedUsername===e&&C.push(i)})}return C},this.handleHeightChange=(P=function(t,e){var i=function(a){a.target===this&&(t.unbind("transitionend",i),e())};t.bind("transitionend",i)},x=function(t,e){t=t||{};var i=LPTools.getOption(t,"animate",!0),a="animating";i&&(t.animationClass&&(a+=" "+t.animationClass),l.addClass(a));var n=function(t){l.removeClass(a),t&&t.transitionEndHandler&&t.transitionEndHandler(),e({callback:t&&t.onFrameResizeComplete})};t.change(function(e){var a=LPTools.getOption(e,"tileHeight",LPTools.getOption(t,"tileHeight",l.children().first().outerHeight())),o=l.height();return l.css("height",a),a!==o&&i?P(l,function(){n(e)}):n(e),a})},function(t){LPTools.getOption(t,"animate",!0)?s.requestAnimationFrame(function(e){x(t,e)}):x(t,function(t){s.setFrameSize(),t&&t.callback&&t.callback()})}),this.showDetails=function(t){this.handleHeightChange($.extend(t,{animationClass:"details-animatation",change:function(e){null===v&&(v=l.height()),s.activeTile&&s.activeTile!==o&&s.activeTile.hideDetails(t),s.activeTile=o,w(t&&t.clearErrors),l.find(".tileContent").append(u),l.addClass("details");var i=e();s.clickedEdit||(s.clickedEdit=!0,s.adjustView(!0),s.adjustScrollHeight(i-v))}}))},this.preSubmit=function(){s.activeTile!==this&&(s.activeTile&&(s.activeTile.hideDetails(),s.activeTile=null),w()),s.vaultItem=e.site,!s.vaultItem&&c.dialogData.fields&&(c.saveOptions.saveFromSubmit=!0)},this.hideDetails=function(t){y=s.getData();var e=u.clone();this.handleHeightChange($.extend(t,{animationClass:"details-animatation",change:function(t){l.find(".tileContent").append(e),l.removeClass("details"),t({transitionEndHandler:function(){e.remove()},tileHeight:v})}}))},this.unselect=function(){m&&(s.selectedTile=null,m=!1,l.removeClass("selected"),s.$element.removeClass("selected"),s.nextButton.prop("disabled",!0))},this.toggleSelect=function(){m?(this.unselect(),this.getDuplicates().forEach(function(t){t.hideDeleteOverlay()})):(this.getDuplicates().forEach(function(t){t.showDeleteOverlay()}),s.tiles.forEach(function(t){t.unselect()}),s.selectedTile=this,m=!0,l.addClass("selected"),s.$element.addClass("selected"),s.nextButton.prop("disabled",!1),t(s,"SaveSiteDialogSelectClicked"))},this.remove=function(){l.remove();for(var t=0;t<s.tiles.length;++t)if(s.tiles[t]===this){s.tiles.splice(t,1);break}},this.showDeleteOverlay=function(){null===d&&((d=h.clone().removeClass("template")).find(".cancelDeleteButton").bind("click",function(){t(s,"SaveSiteDialogDuplicateKeepClicked"),o.hideDeleteOverlay()}),d.find(".deleteButton").bind("click",function(){t(s,"SaveSiteDialogDuplicateDeleteClicked"),e.site.deleteItem({confirm:!1,success:function(){o.remove()}}),o.hideDeleteOverlay()})),l.append(d),l.addClass("duplicate")},this.hideDeleteOverlay=function(){l.removeClass("duplicate"),d.one("animationend",function(){l.hasClass("duplicate")||d.detach()})},this.setSelectable=function(t){S=t;var e=l.find(".favicon");S?(e.addClass("hoverFadeOut"),l.find(".checkmark").LP_show()):(e.removeClass("hoverFadeOut"),l.find(".checkmark").LP_hide()),s.setSelectable(t)},l.find(".tileEdit").addClass("hoverFadeIn"),l.find(".tileEdit").bind("click",function(){t(s,"SaveSiteDialogEditClicked"),o.showDetails({clearErrors:!0})}),l.find(".checkmark").bind("click",function(){o.toggleSelect()}),l.on("click",".showPassword",function(){D=!0}),r.append(l),i(l,e.site?e.site.getFormData(p):c.defaultData),s.tiles.push(this)};if(SiteDialog.prototype.setSiteDialogMessage=function(t,e){var i=!1;if(t.length>1){for(var a=0;a<t.length;++a)new m({site:LPProxy.getSiteModel(t[a])}).setSelectable(!0);d.text(Strings.translateString("Which account should we update?")),this.hasDuplicates()&&c.text(Strings.translateString("Choose one to update and delete the duplicate.")),o.find(".addNewSiteButton").LP_show(),this.nextButton.text(Strings.translateString("Update")),i=!0}else 1===t.length?(l.generatedPasswordSaved?(d.text(Strings.translateString("We've updated your password")),this.nextButton.text(Strings.translateString("OK")),this.backButton.text(Strings.translateString("Undo"))):(d.text(Strings.translateString("Update password?")),this.nextButton.text(Strings.translateString("Update")),o.find(".addNewSiteButton").LP_show()),l.vaultItem=LPProxy.getSiteModel(t[0]),new m({site:l.vaultItem}),i=!0):e&&(l.generatedPasswordSaved?(d.text(Strings.translateString("This site has been added to your LastPass vault")),this.nextButton.text(Strings.translateString("OK")),this.backButton.text(Strings.translateString("Remove")),new m({site:l.vaultItem})):this.setupAdd(l),i=!0);return i},l.matchingSites){var S=!!l.defaultData.unencryptedUsername,v;this.setSiteDialogMessage(l.matchingSites,S)||S||this.setSiteDialogMessage(l.defaultData.domainSites,!S)}!l.generatedPassword||l.generatedPasswordSaved||l.sameDomain||(d.text(Strings.translateString("Oops! What would you like to do with your generated password?")),this.backButton.text(Strings.translateString("Discard"))),DialogWithGroupInput.prototype.setup.apply(this,arguments),this.inputFields.unencryptedUsername.setValues(LPProxy.getSiteUsernames()),this.inputFields.unencryptedUsername.disableClickToggle()},SiteDialog.prototype.setSelectable=function(t){t?(this.$element.addClass("selectable"),this.nextButton.prop("disabled",!0)):(this.$element.removeClass("selectable"),this.nextButton.prop("disabled",!1))},SiteDialog.prototype.validate=function(t){var e=DialogWithGroupInput.prototype.validate.apply(this,arguments);return""===t.unencryptedUsername&&(this.addError("unencryptedUsername",Strings.translateString("Please enter a username.")),e=!1),e},SiteDialog.prototype.getDialogActions=function(t){},SiteDialog.prototype.close=function(t){bg.LPTabState.clear({force:!0}),DialogWithGroupInput.prototype.close.apply(this,arguments)},SiteDialog.prototype.open=function(t){var e=this;o(t,function(i){t.favicon=i,DialogWithGroupInput.prototype.open.call(e,t)})},SiteDialog.prototype.adjustScrollHeight=function(t){this.scrollHeight&&(this.scrollHeight+=t,this.tileContainer.css({"max-height":this.scrollHeight}))},SiteDialog.prototype.setInitialScrollHeight=function(){if(this.tiles.length>3){this.tileContainer=this.$element.find(".tileContainer");var t=this.tileContainer.height(),e=this.$element.find(".tile").first().height(),i=(t-e*this.tiles.length)/(this.tiles.length-1);this.scrollHeight=3.5*e+3*i,this.tileContainer.css({overflow:"auto","max-height":this.scrollHeight})}},SiteDialog.prototype.showInitial=function(){var e;(e=this).requestAnimationFrame(function(i){e.show(),e.setInitialScrollHeight(),e.$element.addClass("animate-enter").one("animationend",function(){e.$element.removeClass("animate-enter"),i()}),t(e,"SaveSiteDialogViewed")})};var l=null,s=!1;SiteDialog.prototype.showInProcessOverlay=function(){if(this.submitted){var t=this.$element;t.addClass("inProcess").one("animationend",function(){t.addClass("waiting"),setTimeout(function(){s=!0,l&&l()},500)})}},SiteDialog.prototype.hideInProcessOverlay=function(){this.$element.removeClass("inProcess waiting")},SiteDialog.prototype.closeOnSuccess=function(){if(this.submitted){var t=this;t.$element.addClass("inProcess waiting");var e=function(){t.$element.removeClass("waiting").addClass("success").one("animationend.success",function(){setTimeout(function(){t.close()},500)})};s?e():l=function(){setTimeout(function(){e()},0)}}},SiteDialog.prototype.performValidate=function(t){var e=this;if(e.selectedTile)if(e.selectedTile===e.activeTile)e.activeTile.handleHeightChange({change:function(i){var a=t.callback;t.callback=function(){var t=arguments;i({onFrameResizeComplete:function(){a&&a.apply(e,t)}})},DialogWithGroupInput.prototype.performValidate.call(e,t)}});else{var i=t.callback;t.callback=function(t){t||e.selectedTile.showDetails(),i&&i.apply(this,arguments)},DialogWithGroupInput.prototype.performValidate.call(e,t)}},SiteDialog.prototype.getErrorOptions=function(){return{static:!0,alignTop:!0,showErrorLabel:!1}},SiteDialog.prototype.submit=function(){1===this.tiles.length&&(this.selectedTile=this.tiles[0]),this.selectedTile.preSubmit(),DialogWithGroupInput.prototype.submit.apply(this,arguments),this.data.generatedPasswordSaved&&!this.data.inputChanged?t(this,"SaveSiteDialogAction","OK"):this.vaultItem?t(this,"SaveSiteDialogAction","Update"):t(this,"SaveSiteDialogAction","Add"),bg.LPTabState.clear({force:!0})};var r=function(t,e){for(var i=0;i<t.length;++i){var a=t[i];if(a.value===e)return a}return null},d=function(t,e){t.fields&&t.fields.forEach(function(i){t.unencryptedUsername&&t.unencryptedUsername===i.value&&"password"!==i.type?i.value=e.unencryptedUsername:"password"===i.type&&(i.value=e.password)})},c=function(t,e,i){if(i.fields){d(e,i),d(t,i);var a=e.fields?e.fields:[];t.fields&&(a=a.concat(t.fields.filter(function(t){for(var e=0;e<a.length;++e){var i=a[e];if(t.type===i.type&&t.name===i.name&&t.formname===i.formname)return!1}return!0}))),i.fields=a}};SiteDialog.prototype.handleSubmit=function(t){this.submitted=!0,c(this.selectedTile.getOriginalDialogData(),this.selectedTile.getOriginalData(),t),DialogWithGroupInput.prototype.handleSubmit.apply(this,arguments)}}();
//# sourceMappingURL=sourcemaps/contentScriptSiteDialog.js.map
