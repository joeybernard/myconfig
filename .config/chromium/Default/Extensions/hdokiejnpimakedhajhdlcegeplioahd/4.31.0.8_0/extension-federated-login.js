var FederatedLogin=function(){var e;return new function(){var e=this,r={},t=!1;FederatedLoginService.call(e),e._ajax=function(e){"undefined"!=typeof base_url&&0!==e.url.indexOf("http")&&(e.url=base_url+e.url),LPServer.ajax(e)},e.login=function(r){r=fix_username(r),e.getPassword(r,function(e,t,o,n){setFragmentId(o,n),LP_do_login(r,e,void 0,void 0,void 0,void 0,void 0,void 0,void 0,t)},lpshowError)};var o=function(r,t){if(r.keypair){var o,n,a=(new DOMParser).parseFromString(atob(t),"application/xml").querySelector('Attribute[Name="LastPassKeyPart"]').childNodes[0].textContent;r.valid=!!e._decryptK1WithPrivateKey(atob(a),r.keypair.privateKey),r.submitted=!0,r.valid||e._handleError(r.error,new Error(gs("K1 not valid!")))}},n=function(e){var r={},t;return e.split("&").forEach(function(e){var t=e.split("=");2===t.length&&(r[t[0]]=decodeURIComponent(t[1]))}),r},a=function(e){try{if(e&&e.formData&&e.formData.SAMLResponse&&1===e.formData.SAMLResponse.length)return e.formData.SAMLResponse[0];if(e&&e.raw){var r=e.raw.reduce(function(e,r){return e+String.fromCharCode.apply(null,new Uint8Array(r.bytes))},"");if(r.length>0){var t=n(r);if(t.SAMLResponse)return t.SAMLResponse}}}catch(e){console.log(e)}return null};e.getPasswordSaml=function(t,n,i){t=fix_username(t),LPPlatform.getCurrentTabDetails(function(s){e._initiate(t,function(l,d){var u={valid:!1,idp:l,keypair:d,submitted:!1,error:i};LPPlatform.openTab({extension:!0,url:l.IdentityProviderURL+"/auth/saml2/"+l.IdentityProviderGUID,loadHandler:function(c){u.cleanup=LPPlatform.onBeforeNavigate(function(r,f){var p=/\/auth\/saml2\/success\/(.*)$/.exec(r);if(p&&2===p.length)return u.valid||!d?e._getAuthInfo(t,p[1],function(r){e._assemblePassword(t,d,r,function(e){n(e,r.authSessionId)},i)},i):e._handleError(i,new Error(gs("K1 not valid!"))),u.submitted=!0,LPPlatform.closeTab(c.tabDetails),LPPlatform.activateTab(s),!1;if(d&&!u.valid&&0===r.indexOf(l.IdentityProviderURL)){var m=a(f);if(m)return o(u,m),u.valid}},c.tabDetails),r[c.tabDetails.tabID]=u},closeHandler:function(){u.submitted||e._handleError(i,new Error(gs("Federated login tab closed!")))}})})})},e.getPassword=function(r,o,n){r=fix_username(r),LPPlatform.getCurrentTabDetails(function(a){e._initiate(r,function(a,i){var s={valid:!1,idp:a,keypair:i,submitted:!1,error:n};if(s.idp.type<=2)e.getPasswordSaml(r,o,n);else{3!=s.idp.type&&n(),Oidc.Log.logger=console,Oidc.Log.level=Oidc.Log.INFO;var l={authority:s.idp.OpenIDConnectAuthority,client_id:s.idp.OpenIDConnectClientId,redirect_uri:"https://accounts.lastpass.com/federated/oidcredirect.html",response_type:"id_token token",scope:"openid email profile",signingKeys:s.idp.OpenIDConnectKeys},d=new Oidc.OidcClient(l);d.createSigninRequest().then(function(a){t?t=!1:(t=!0,LPPlatform.openTab({extension:!0,url:a.url,closeHandler:function(){t=!1,s.submitted||e._handleError(n,new Error(gs("Federated login tab closed!")))},loadHandler:function(){},onBeforeRequestCallback:function(a,i,l){function u(e){return[gs("Azure AD reported a problem during login."),gs("Contact your Azure AD administrator for assistance."),gs("Hereâ€™s the message from Azure AD:"),e].join("<br/><br/>")}/https:\/\/accounts\.lastpass\.com\/federated\/oidcredirect\.html.*/.test(a)&&d.processSigninResponse(a).then(function(a){if(s.submitted=!0,LPPlatform.closeTab({tabID:l}),t=!1,a.error)return console.log(a.error),e._handleError(n,new Error(getErrorMessage(a.error))),!1;if(!a.profile)return e._handleError(n,new Error(gs("No profile information."))),!1;var i=a.profile.mail?a.profile.mail.toLowerCase():void 0,d=a.profile.preferred_username?a.profile.preferred_username.toLowerCase():void 0;if(i!=r.toLowerCase()&&d!=r.toLowerCase()){var u=[gs("Use the same account to log in to both Azure AD and LastPass."),"<br/><br/>",gs("Current Azure AD account:")+" "+(i||d||gs("unknown")),"<br/>",gs("Attempted LastPass account:")+" "+r].join("");return e._handleError(n,new Error(u)),!1}return e._assemblePasswordForOIDC(a.id_token,a.access_token,s.idp.CompanyId,alp_url,o,n),!0}).catch(function(r){console.log(r);var t=decodeURIComponent(r.error_description.replace(/\+/g,"%20"));e._handleError(n,new Error(u(t)))})}}))})}})})},e.validateK1Encryption=function(e,t,n){var a=!0,i=r[n.tabID];i&&i.keypair&&(o(i,e),a=i.valid),t&&t(a)},LPPlatform.onTabClosed(function(e){r[e]&&(r[e].cleanup(),delete r[e])})}}();
//# sourceMappingURL=sourcemaps/extension-federated-login.js.map
